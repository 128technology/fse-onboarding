{"body":"{% for instance in instances %}\n{% editgroup %}\n{% capture dns_service_name %}{{ instance.variables['routerName'] }}-dns{% endcapture %}\n{% capture mgmt_service_name %}{{ instance.variables['routerName']}}-mgmt{% endcapture %}\n{\n  \"authority\": {\n    \"router\": [\n      {\n        \"name\": \"{{instance.variables['routerName']}}\",\n        \"location\": \"{{instance.variables['location']}}\",\n        \"locationCoordinates\": \"{{instance.variables['locationCoordinates']}}\",\n        \"routerGroup\": [\n          \"l3nid\"\n        ],\n        \"interNodeSecurity\": \"{{instance.variables['interNodeSecurity']}}\",\n        \"node\": [\n          {\n            \"name\": \"node1\",\n            \"role\": \"combo\",\n            \"deviceInterface\": [\n              {\n                \"name\": \"provider\",\n                \"pciAddress\": \"{{instance.variables['provider_pciAddress']}}\",\n                \"networkInterface\": [\n                  {\n                    \"name\": \"provider\",\n                    \"address\": [\n                      {\n                        \"ipAddress\": \"{{instance.variables['provider_ipAddress']}}\",\n                        \"prefixLength\": \"{{instance.variables['provider_prefixLength']}}\",\n                        \"gateway\": \"{{instance.variables['provider_gateway']}}\"\n                      }\n                    ],\n                    \"sourceNat\": \"false\",\n                    \"conductor\": \"true\",\n                    \"tenant\": \"{{instance.variables['provider_tenant']}}\",\n                    \"interRouterSecurity\": \"{{instance.variables['interRouterSecurity']}}\",\n                    \"neighborhood\": [\n                      {\n                        \"name\": \"{{instance.variables['neighborhood_name']}}\",\n                        \"pathMtuDiscovery\": {\n                          \"enabled\": \"true\"\n                        }\n                      }\n                    ],\n                    \"management\": \"true\",\n                    \"defaultRoute\": \"true\",\n                    \"managementVector\": {\n                      \"name\": \"provider\",\n                      \"priority\": \"100\"\n                    },\n                    \"egressSourceNatPool\": \"mgmt-egress\"\n                  }\n                ]\n              },\n              {\n                \"name\": \"customer\",\n                \"pciAddress\": \"{{instance.variables['customer_pciAddress']}}\",\n                \"networkInterface\": [\n                  {\n                    \"name\": \"customer\",\n                    \"tenant\": \"{{instance.variables['customer_tenant']}}\",\n                    \"address\": [\n                      {\n                        \"ipAddress\": \"{{instance.variables['provider_gateway']}}\",\n                        \"prefixLength\": \"{{instance.variables['provider_prefixLength']}}\",\n                        \"gateway\": \"{{instance.variables['provider_ipAddress']}}\"\n                      }\n                    ]\n                  }\n                ]\n              }\n            ],\n            \"reverseSsh\": {}\n          }\n        ],\n        \"dnsConfig\": [\n          {\n            \"mode\": \"static\",\n            \"address\": [\n              {%- for address in instance.variables['dns_servers'] %}\n              \"{{ address }}\"{% if forloop.last == false %},{% endif %}\n              {%- endfor %}\n            ]\n          }\n        ],\n        \"applicationIdentification\": {\n          \"mode\": [\n            \"tls\",\n            \"module\"\n          ]\n        },\n        \"entitlement\": {\n          \"id\": \"128T-FSE-L3NID-{{instance.variables['entitlement_mbs']}}-{{instance.variables['entitlement_end_date']}}\",\n          \"maxBandwidth\": \"{{instance.variables['entitlement_mbs']}}000000\"\n        },\n        \"system\": {\n          \"ntp\": {\n            \"server\": [\n              {%- for address in instance.variables['ntp_servers'] %}\n              {\n                \"ipAddress\": \"{{ address }}\"\n              }{% if forloop.last == false %},{% endif %}\n              {%- endfor %}\n            ]\n          }\n        },\n        \"serviceRoute\": [\n          {\n            \"name\": \"l3nid-inbound\",\n            \"serviceName\": \"l3nid-inbound\",\n            \"nextHop\": [\n              {\n                \"nodeName\": \"node1\",\n                \"interface\": \"customer\",\n                \"gatewayIp\": \"{{instance.variables['provider_ipAddress']}}\"\n              }\n            ]\n          },\n          {\n            \"name\": \"l3nid-outbound\",\n            \"serviceName\": \"l3nid-outbound\",\n            \"nextHop\": [\n              {\n                \"nodeName\": \"node1\",\n                \"interface\": \"provider\",\n                \"gatewayIp\": \"{{instance.variables['provider_gateway']}}\"\n              }\n            ]\n          },\n          {\n            \"name\": \"dns\",\n            \"serviceName\": \"{{ dns_service_name }}\",\n            \"nextHop\": [\n              {\n                \"nodeName\": \"node1\",\n                \"interface\": \"provider\",\n                \"gatewayIp\": \"{{instance.variables['provider_gateway']}}\"\n              }\n            ]\n          },\n          {\n            \"name\": \"mgmt\",\n            \"serviceName\": \"{{ mgmt_service_name }}\",\n            \"host\": [\n              {\n                \"nodeName\": \"node1\",\n                \"targetAddress\": [\n                  \"169.254.127.127\"\n                ]\n              }\n            ]\n          }\n        ],\n        \"dnsCache\": {\n          \"tenant\": \"_internal_\",\n          \"ingressService\": \"{{ dns_service_name }}\"\n        },\n        \"dnsAppId\": {\n          \"includeAllBuiltinApps\": \"true\"\n        },\n        \"natPool\": [\n          {\n            \"name\": \"mgmt-egress\",\n            \"addressPool\": [\n              {\n                \"address\": \"{{instance.variables['provider_ipAddress']}}/32\",\n                \"tenantName\": [\n                  \"_internal_\"\n                ]\n              }\n            ]\n          }\n        ]\n      }\n    ],\n    \"tenant\": [\n      {\n        \"name\": \"{{instance.variables['provider_tenant']}}\"\n      },\n      {\n        \"name\": \"{{instance.variables['customer_tenant']}}\"\n      }\n    ],\n    \"service\": [\n      {\n        \"name\": \"l3nid-outbound\",\n        \"accessPolicy\": [\n          {\n            \"source\": \"{{instance.variables['customer_tenant']}}\"\n          }\n        ]\n      },\n      {\n        \"name\": \"{{ mgmt_service_name }}\",\n        \"appliesTo\": [\n          {\n            \"type\": \"router\",\n            \"routerName\": [\n              \"{{instance.variables['routerName']}}\"\n            ]\n          },\n          {\n            \"type\": \"router-group\",\n            \"groupName\": [\n              \"datacenter\"\n            ]\n          }\n        ],\n        \"security\": \"{{instance.variables['management_service_security']}}\",\n        \"address\": [\n          \"{{instance.variables['management_loopback']}}/32\"\n        ],\n        \"accessPolicy\": [\n          {\n            \"source\": \"{{instance.variables['management_tenant']}}\"\n          }\n        ]\n      },\n      {\n        \"name\": \"{{ dns_service_name }}\",\n        \"appliesTo\": [\n          {\n            \"type\": \"router\",\n            \"routerName\": [\n              \"{{instance.variables['routerName']}}\"\n            ]\n          }\n        ],\n        \"accessPolicy\": [\n          {\n            \"source\": \"{{instance.variables['customer_tenant']}}\"\n          }\n        ],\n        \"address\": [\n            {%- for address in instance.variables['dns_servers'] %}\n            \"{{ address }}\"{% if forloop.last == false %},{% endif %}\n            {%- endfor %}\n        ],\n        \"transport\": [\n          {\n            \"protocol\": \"udp\",\n            \"portRange\": [\n              {\n                \"startPort\": \"53\"\n              }\n            ]\n          }\n        ]\n      }\n    ]\n  }\n}\n{% endfor %}"}